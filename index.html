<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Digital Human Only</title>
    <style>
        /* 1. 强制全透明和无滚动条 */
        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            background-color: transparent !important;
        }

        /* 2. 让容器透明，但不影响交互 */
        body > div {
            background-color: transparent !important;
        }

        /* 确保 Canvas（数字人本身）可见 */
        canvas {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
    </style>
</head>
<body>
    <!-- 先加载 SDK（移除 type="module" 避免加载时序问题） -->
    <script src="https://avatar.gbqr.net/yiyu.js"></script>

    <script>
        // 初始化状态标记
        let isReady = false;
        let initAttempts = 0;
        const maxAttempts = 50; // 最多尝试 5 秒

        // 通知 iOS 端的辅助函数
        function notifyiOS(handler, message) {
            try {
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers[handler]) {
                    window.webkit.messageHandlers[handler].postMessage(message);
                }
            } catch (e) {
                console.log('iOS handler not available:', handler);
            }
        }

        // 初始化数字人
        function initAvatar() {
            if (window.yiyu && window.yiyu.app) {
                console.log('[Avatar] yiyu SDK found, initializing...');
                
                yiyu.app.init({
                    name: 'HLkkvXQwNjEZWePBrQ3OD30irHbxVN7RL7dDeGNehLqfnlkBA+9pro9rGhTgwYNEQY5Yuey5+ueXY7Yr1BgVn/IjerYbX9YH1U3Toe7X5ByM4yJ+feudfabdp+Nz/rOgvY2x5Kt3a6+S+ESCcyxk2Z9CbqCeUjas6xw9+svMthc=', 
                    readLocalResource: false,
                    draggable: false,
                    showToast: false 
                });

                yiyu.app.onAppReady(function() {
                    console.log('[Avatar] App is ready!');
                    
                    yiyu.app.disableHyperTranslation();
                    yiyu.app.disableTextSelection();
                    
                    yiyu.app.setPosition(0, 0); 
                    yiyu.app.setSize('100%', '100%');
                    yiyu.app.setAvatarSize(1);
                    
                    isReady = true;
                    console.log('[Avatar] Avatar is ready for commands');
                    
                    // 通知 iOS 原生端加载完成
                    notifyiOS('loadComplete', 'ready');
                });

                yiyu.app.onError(function(error) {
                    console.error('[Avatar] Error:', error);
                    notifyiOS('loadError', error.message || 'Unknown error');
                });

            } else {
                initAttempts++;
                if (initAttempts < maxAttempts) {
                    console.log('[Avatar] Waiting for yiyu SDK... attempt', initAttempts);
                    setTimeout(initAvatar, 100);
                } else {
                    console.error('[Avatar] Failed to load yiyu SDK after', maxAttempts, 'attempts');
                    notifyiOS('loadError', 'SDK load timeout');
                }
            }
        }

        // 页面加载完成后开始初始化
        if (document.readyState === 'complete') {
            initAvatar();
        } else {
            window.addEventListener('load', initAvatar);
        }

        // --- 供 iOS 原生调用的接口 ---

        window.sendSignText = function(text) {
            console.log('[Avatar] sendSignText called:', text.substring(0, 50) + '...');
            if (isReady && window.yiyu && window.yiyu.app) {
                yiyu.app.startTranslate(text);
                notifyiOS('debugLog', 'Translation started');
            } else {
                console.warn('[Avatar] Not ready, command ignored. isReady:', isReady);
                notifyiOS('debugLog', 'Command ignored - not ready');
            }
        };

        window.stopSign = function() {
            console.log('[Avatar] stopSign called');
            if (isReady && window.yiyu && window.yiyu.app) {
                yiyu.app.cancelTranslation();
            }
        };

        // 调试：检查 URL 参数中的初始文本
        const urlParams = new URLSearchParams(window.location.search);
        const initialText = urlParams.get('text');
        if (initialText) {
            console.log('[Avatar] Initial text from URL:', initialText.substring(0, 50) + '...');
            // 等待 ready 后自动翻译
            const checkAndTranslate = setInterval(function() {
                if (isReady) {
                    clearInterval(checkAndTranslate);
                    window.sendSignText(decodeURIComponent(initialText));
                }
            }, 500);
            // 30 秒后放弃
            setTimeout(function() { clearInterval(checkAndTranslate); }, 30000);
        }
    </script>
</body>
</html>
